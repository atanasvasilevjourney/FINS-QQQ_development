//@version=5
strategy("Z-Score Mean Reversion", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// Input Parameters
lookback_period = input.int(20, "Lookback Period", minval=5, maxval=100, group="Z-Score Settings")
entry_threshold = input.float(2.0, "Entry Threshold", minval=1.0, maxval=4.0, step=0.1, group="Z-Score Settings")
exit_threshold = input.float(0.5, "Exit Threshold", minval=0.1, maxval=2.0, step=0.1, group="Z-Score Settings")
price_source = input.source(close, "Price Source", group="Z-Score Settings")

// Risk Management
stop_loss_pct = input.float(3.0, "Stop Loss %", minval=0.1, maxval=10.0, step=0.1, group="Risk Management")
max_positions = input.int(1, "Max Positions", minval=1, maxval=5, group="Risk Management")

// Z-Score Calculation
rolling_mean = ta.sma(price_source, lookback_period)
rolling_std = ta.stdev(price_source, lookback_period)
zscore = (price_source - rolling_mean) / rolling_std

// Z-Score values (no plotting - use separate indicator)

// Entry Conditions
long_entry = zscore < -entry_threshold and zscore[1] >= -entry_threshold
short_entry = zscore > entry_threshold and zscore[1] <= entry_threshold

// Exit Conditions
long_exit = zscore > -exit_threshold or zscore > exit_threshold
short_exit = zscore < exit_threshold or zscore < -exit_threshold

// Position Management
current_positions = strategy.position_size != 0 ? 1 : 0

// Entry Logic
if long_entry and current_positions < max_positions
    stop_level = close * (1 - stop_loss_pct / 100)
    strategy.entry("Long", strategy.long)
    strategy.exit("Long Exit", "Long", stop=stop_level)

if short_entry and current_positions < max_positions
    stop_level = close * (1 + stop_loss_pct / 100)
    strategy.entry("Short", strategy.short)
    strategy.exit("Short Exit", "Short", stop=stop_level)

// Exit Logic (Mean Reversion)
if long_exit and strategy.position_size > 0
    strategy.close("Long", comment="Mean Revert Exit")

if short_exit and strategy.position_size < 0
    strategy.close("Short", comment="Mean Revert Exit")

// Visual Indicators
plotshape(long_entry, title="Long Entry", location=location.belowbar, style=shape.triangleup, size=size.small, color=color.green)
plotshape(short_entry, title="Short Entry", location=location.abovebar, style=shape.triangledown, size=size.small, color=color.red)
